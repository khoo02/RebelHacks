<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realistic Blackjack â€” BlackJack Brawl</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    /* â”€â”€ RESET & ROOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0f0a;
      --felt: #0d2010;
      --felt-mid: #102812;
      --gold: #c9a84c;
      --gold-dim: rgba(201,168,76,0.35);
      --red: #c0392b;
      --green: #27ae60;
      --card-bg: #fdf8ee;
      --text: #e8dfc8;
      --text-dim: rgba(232,223,200,0.55);
      --border: rgba(201,168,76,0.3);
      --hud-bg: rgba(5,8,5,0.92);
      --debt-col: #e74c3c;
      --win-col: #2ecc71;
    }

    body {
      background: var(--bg);
      font-family: 'Crimson Text', serif;
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      background-image:
        radial-gradient(ellipse at 50% 50%, rgba(13,32,16,0.9) 0%, rgba(10,15,10,1) 100%),
        repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(201,168,76,0.015) 40px, rgba(201,168,76,0.015) 41px),
        repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(201,168,76,0.015) 40px, rgba(201,168,76,0.015) 41px);
    }

    /* â”€â”€ ANTI-GAMBLING HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #ag-hud {
      position: sticky;
      top: 0;
      z-index: 200;
      display: flex;
      background: var(--hud-bg);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(8px);
    }

    .ag-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.45rem 0.4rem;
      border-right: 1px solid rgba(201,168,76,0.08);
      gap: 0.1rem;
    }
    .ag-block:last-child { border-right: none; }

    .ag-lbl {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.42rem;
      letter-spacing: 0.18em;
      color: var(--text-dim);
    }

    .ag-val {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.82rem;
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }

    #hud-timer.warn-orange { color: #e67e22; }
    #hud-timer.warn-red    { color: var(--debt-col); text-shadow: 0 0 8px rgba(231,76,60,0.5); }
    #hud-debt.in-debt      { color: var(--debt-col); }
    #hud-debt.in-profit    { color: var(--win-col); }
    #hud-winrate.losing    { color: var(--debt-col); }
    #hud-winrate.winning   { color: var(--win-col); }

    .hud-house { font-size: 0.68rem !important; color: var(--text-dim) !important; }

    /* â”€â”€ STREAK / TIME BANNERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ag-banner {
      padding: 0.45rem 1rem;
      font-size: 0.82rem;
      font-style: italic;
      text-align: center;
      border-bottom: 1px solid;
      display: none;
    }
    .ag-banner.show { display: block; }
    .ag-banner.streak {
      background: rgba(192,57,43,0.1);
      border-color: rgba(192,57,43,0.35);
      color: #e8b4af;
    }
    .ag-banner.time-warn {
      background: rgba(230,126,34,0.1);
      border-color: rgba(230,126,34,0.3);
      color: #f0c080;
    }

    /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #game-wrap {
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 48px);
      max-width: 760px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* â”€â”€ DEALER ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #dealer-zone {
      padding: 1.5rem 0 1rem;
    }

    .zone-label {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      color: var(--text-dim);
      margin-bottom: 0.6rem;
    }

    .hand-score {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      min-height: 1.4rem;
      color: var(--gold);
    }

    /* â”€â”€ CARD ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card-row {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
      min-height: 110px;
      align-items: flex-end;
    }

    /* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      width: 72px;
      height: 104px;
      border-radius: 7px;
      flex-shrink: 0;
    }

    .card-inner {
      width: 100%;
      height: 100%;
      border-radius: 7px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.45s ease;
    }

    .card.flip .card-inner { animation: flipCard 0.45s ease forwards; }
    @keyframes flipCard {
      0%   { transform: rotateY(0); }
      50%  { transform: rotateY(90deg); }
      100% { transform: rotateY(0); }
    }

    .card-face, .card-back {
      position: absolute;
      inset: 0;
      border-radius: 7px;
      backface-visibility: hidden;
    }

    .card-face {
      background: var(--card-bg);
      border: 1.5px solid rgba(0,0,0,0.12);
      box-shadow: 0 3px 12px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      padding: 4px;
      animation: dealIn 0.35s cubic-bezier(0.175,0.885,0.32,1.275) forwards;
    }

    .card-back {
      background: linear-gradient(135deg, #0d2010, #1a3a1a);
      border: 1.5px solid rgba(201,168,76,0.5);
      box-shadow: 0 3px 12px rgba(0,0,0,0.5);
      background-image: repeating-linear-gradient(
        45deg,
        rgba(201,168,76,0.04) 0, rgba(201,168,76,0.04) 2px,
        transparent 2px, transparent 10px
      );
      display: flex;
      align-items: center;
      justify-content: center;
      animation: dealIn 0.35s cubic-bezier(0.175,0.885,0.32,1.275) forwards;
    }
    .card-back::after { content: 'â™ '; font-size: 2rem; opacity: 0.15; color: var(--gold); }

    @keyframes dealIn {
      from { transform: scale(0.6) rotate(-15deg); opacity: 0; }
      to   { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .corner { position: absolute; font-size: 0.62rem; font-weight: 700; line-height: 1.1; }
    .corner.tl { top: 4px; left: 5px; }
    .corner.br { bottom: 4px; right: 5px; transform: rotate(180deg); }
    .center-suit { font-size: 1.9rem; margin: auto; }

    .red .corner, .red .center-suit { color: #c0392b; }
    .black .corner, .black .center-suit { color: #111; }

    /* â”€â”€ DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #table-divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0.5rem 0;
      opacity: 0.4;
    }

    /* â”€â”€ MESSAGE BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #msg-box {
      padding: 0.7rem 1rem;
      background: rgba(5,8,5,0.7);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      font-style: italic;
      text-align: center;
      min-height: 2.6rem;
      margin: 0.75rem 0;
    }

    /* â”€â”€ PLAYER ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #player-zone {
      padding: 0.5rem 0 1rem;
    }

    /* â”€â”€ BALANCE / BETTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #bet-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 0.75rem 0;
      flex-wrap: wrap;
    }

    .balance-display {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.85rem;
      color: var(--text-dim);
    }
    .balance-display span { color: var(--gold); }

    .chip {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: 3px dashed rgba(255,255,255,0.4);
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.6rem;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }
    .chip:hover:not(:disabled) { transform: scale(1.12) translateY(-3px); filter: brightness(1.2); }
    .chip:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

    .chip-1   { background: radial-gradient(circle at 35% 35%, #e0e0e0, #888); }
    .chip-5   { background: radial-gradient(circle at 35% 35%, #e74c3c, #922b21); }
    .chip-25  { background: radial-gradient(circle at 35% 35%, #2ecc71, #1a8a47); }
    .chip-100 { background: radial-gradient(circle at 35% 35%, #3498db, #1a5276); }
    .chip-500 { background: radial-gradient(circle at 35% 35%, #9b59b6, #5b2c6f); }

    #current-bet-display {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-left: auto;
    }
    #current-bet-display span { color: var(--gold); font-size: 1rem; }

    /* â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #action-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    .btn {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.78rem;
      padding: 0.6rem 1.4rem;
      border: none;
      cursor: pointer;
      letter-spacing: 0.05em;
      border-radius: 4px;
      transition: all 0.15s;
      clip-path: polygon(5px 0%, calc(100% - 5px) 0%, 100% 5px, 100% calc(100% - 5px), calc(100% - 5px) 100%, 5px 100%, 0% calc(100% - 5px), 0% 5px);
    }
    .btn:disabled { opacity: 0.25; cursor: not-allowed; }
    .btn:not(:disabled):hover { transform: scale(1.04); }

    .btn-deal   { background: linear-gradient(135deg, #c9a84c, #9a7a2a); color: #0a0f0a; }
    .btn-deal:not(:disabled):hover { box-shadow: 0 0 18px rgba(201,168,76,0.5); }

    .btn-hit    { background: linear-gradient(135deg, #27ae60, #1a7a40); color: white; }
    .btn-hit:not(:disabled):hover { box-shadow: 0 0 18px rgba(39,174,96,0.5); }

    .btn-stand  { background: linear-gradient(135deg, #c9a84c, #9a7a2a); color: #0a0f0a; }
    .btn-stand:not(:disabled):hover { box-shadow: 0 0 18px rgba(201,168,76,0.5); }

    .btn-double { background: linear-gradient(135deg, #8e44ad, #5b2c6f); color: white; }
    .btn-double:not(:disabled):hover { box-shadow: 0 0 18px rgba(142,68,173,0.5); }

    .btn-clear  { background: rgba(255,255,255,0.06); color: var(--text-dim); border: 1px solid var(--border); }
    .btn-back   { background: rgba(255,255,255,0.06); color: var(--text-dim); border: 1px solid var(--border); font-size: 0.7rem; padding: 0.5rem 1rem; }

    /* â”€â”€ DAMAGE FLASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #flash {
      position: fixed; inset: 0; pointer-events: none; z-index: 900;
      opacity: 0; transition: opacity 0.1s;
    }

    /* â”€â”€ WIN NUDGE OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #win-nudge {
      display: none;
      position: fixed; inset: 0;
      background: rgba(5,8,5,0.88);
      z-index: 700;
      align-items: center;
      justify-content: center;
    }
    #win-nudge.show { display: flex; }

    .nudge-box {
      background: rgba(13,32,16,0.95);
      border: 1px solid var(--gold-dim);
      border-radius: 10px;
      padding: 2rem 2.5rem;
      max-width: 340px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.6rem;
    }
    .nudge-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 1rem;
      color: var(--gold);
    }
    .nudge-body { font-size: 0.92rem; font-style: italic; color: var(--text-dim); line-height: 1.6; }
    .nudge-dismiss {
      margin-top: 0.5rem;
      background: transparent;
      border: 1px solid var(--gold-dim);
      color: var(--text-dim);
      padding: 0.4rem 1.2rem;
      cursor: pointer;
      border-radius: 4px;
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.6rem;
      letter-spacing: 0.06em;
      transition: all 0.2s;
    }
    .nudge-dismiss:hover { color: var(--gold); border-color: var(--gold); }

    /* â”€â”€ GAME OVER OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #gameover {
      display: none;
      position: fixed; inset: 0;
      background: rgba(5,8,5,0.92);
      z-index: 800;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 2rem;
      overflow-y: auto;
    }
    #gameover.show { display: flex; }

    #go-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 2.5rem;
      margin-bottom: 0.3rem;
    }
    .go-win  { color: var(--gold); text-shadow: 0 0 30px rgba(201,168,76,0.7); }
    .go-lose { color: var(--debt-col); text-shadow: 0 0 30px rgba(231,76,60,0.7); }
    .go-push { color: #7f8c8d; }

    /* â”€â”€ SESSION REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #report {
      background: rgba(13,32,16,0.8);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      max-width: 480px;
      width: 100%;
      margin-top: 1.2rem;
    }

    .report-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.68rem;
      letter-spacing: 0.15em;
      color: var(--gold);
      opacity: 0.75;
      text-align: center;
      margin-bottom: 1rem;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.6rem;
      margin-bottom: 1rem;
    }

    .r-stat {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(201,168,76,0.1);
      border-radius: 6px;
      padding: 0.55rem 0.75rem;
      text-align: center;
    }
    .r-stat-lbl {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.48rem;
      letter-spacing: 0.1em;
      color: var(--text-dim);
      margin-bottom: 0.25rem;
    }
    .r-stat-val {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 1.05rem;
    }

    .debt-box {
      background: rgba(192,57,43,0.1);
      border: 1px solid rgba(192,57,43,0.3);
      border-radius: 8px;
      padding: 0.9rem;
      text-align: center;
      margin-bottom: 0.75rem;
    }
    .debt-box.profit {
      background: rgba(46,204,113,0.08);
      border-color: rgba(46,204,113,0.25);
    }
    .debt-box-lbl {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.5rem;
      letter-spacing: 0.15em;
      color: var(--debt-col);
      margin-bottom: 0.3rem;
    }
    .debt-box.profit .debt-box-lbl { color: var(--win-col); }
    .debt-box-amount {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 2rem;
      color: var(--debt-col);
    }
    .debt-box.profit .debt-box-amount { color: var(--win-col); }

    .could-buy { margin-bottom: 0.75rem; }
    .could-buy-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.58rem;
      letter-spacing: 0.1em;
      color: var(--text-dim);
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .buy-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      justify-content: center;
    }
    .buy-item {
      background: rgba(201,168,76,0.07);
      border: 1px solid rgba(201,168,76,0.2);
      border-radius: 5px;
      padding: 0.3rem 0.65rem;
      font-size: 0.82rem;
      color: var(--text-dim);
      font-style: italic;
    }

    .report-reminder {
      font-size: 0.76rem;
      color: var(--text-dim);
      font-style: italic;
      line-height: 1.65;
      text-align: center;
      border-top: 1px solid rgba(201,168,76,0.1);
      padding-top: 0.75rem;
      margin-top: 0.25rem;
    }
    .helpline {
      display: block;
      margin-top: 0.4rem;
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.55rem;
      letter-spacing: 0.06em;
      color: var(--gold);
      opacity: 0.6;
      text-decoration: none;
    }
    .helpline:hover { opacity: 1; }

    .go-btns {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 1.2rem;
    }

    .btn-lg {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.9rem;
      padding: 0.75rem 2rem;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      clip-path: polygon(6px 0%, calc(100% - 6px) 0%, 100% 6px, 100% calc(100% - 6px), calc(100% - 6px) 100%, 6px 100%, 0% calc(100% - 6px), 0% 6px);
      transition: all 0.2s;
    }
    .btn-lg-gold  { background: linear-gradient(135deg, #c9a84c, #9a7a2a); color: #0a0f0a; }
    .btn-lg-muted { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-dim); }
    .btn-lg:hover { transform: scale(1.04); }

    /* Responsive */
    @media(max-width:560px) {
      .card { width: 58px; height: 84px; }
      .center-suit { font-size: 1.5rem; }
      .chip { width: 40px; height: 40px; font-size: 0.55rem; }
      #go-title { font-size: 1.8rem; }
      .debt-box-amount { font-size: 1.5rem; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ODDS TRACKER PANEL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #odds-panel {
      background: rgba(5,8,5,0.85);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.85rem 1rem;
      margin: 0.5rem 0;
      display: none;
    }
    #odds-panel.visible { display: block; }

    .odds-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.65rem;
    }
    .odds-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.58rem;
      letter-spacing: 0.15em;
      color: var(--gold);
      opacity: 0.75;
    }
    .odds-info-btn {
      background: none;
      border: 1px solid var(--gold-dim);
      color: var(--text-dim);
      font-size: 0.65rem;
      width: 18px; height: 18px;
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .odds-info-btn:hover { color: var(--gold); border-color: var(--gold); }

    .odds-row {
      display: grid;
      grid-template-columns: 90px 1fr 52px;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.45rem;
    }
    .odds-row:last-of-type { margin-bottom: 0; }

    .odds-lbl {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.48rem;
      letter-spacing: 0.08em;
      color: var(--text-dim);
      white-space: nowrap;
    }

    .odds-bar-track {
      height: 8px;
      background: rgba(255,255,255,0.06);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .odds-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.55s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    /* Perceived = what most players feel; warm amber */
    .bar-perceived { background: linear-gradient(90deg, #c9a84c, #e8c46a); }
    /* Actual = mathematically derived; cool blue-green */
    .bar-actual    { background: linear-gradient(90deg, #1abc9c, #27ae60); }
    /* Bust risk = danger red */
    .bar-bust      { background: linear-gradient(90deg, #c0392b, #e74c3c); }

    .odds-pct {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.72rem;
      text-align: right;
      white-space: nowrap;
    }
    .pct-perceived { color: #c9a84c; }
    .pct-actual    { color: #1abc9c; }
    .pct-bust      { color: #e74c3c; }

    /* Gap callout */
    .odds-gap {
      margin-top: 0.55rem;
      padding: 0.35rem 0.6rem;
      border-radius: 5px;
      font-size: 0.75rem;
      font-style: italic;
      display: none;
      line-height: 1.45;
    }
    .odds-gap.show { display: block; }
    .odds-gap.overconfident {
      background: rgba(192,57,43,0.1);
      border-left: 2px solid rgba(192,57,43,0.5);
      color: #e8b4af;
    }
    .odds-gap.underconfident {
      background: rgba(201,168,76,0.07);
      border-left: 2px solid rgba(201,168,76,0.3);
      color: var(--text-dim);
    }

    /* Tooltip overlay */
    #odds-tooltip {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 750;
      background: rgba(5,8,5,0.82);
      align-items: center;
      justify-content: center;
    }
    #odds-tooltip.show { display: flex; }
    .tooltip-box {
      background: rgba(13,32,16,0.97);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      max-width: 380px;
      width: 90%;
    }
    .tooltip-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.75rem;
      color: var(--gold);
      margin-bottom: 0.75rem;
      letter-spacing: 0.1em;
    }
    .tooltip-body {
      font-size: 0.88rem;
      line-height: 1.7;
      color: var(--text-dim);
    }
    .tooltip-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.4rem 0;
    }
    .tooltip-swatch {
      width: 12px; height: 12px; border-radius: 2px; flex-shrink: 0;
    }
    .swatch-perceived { background: #c9a84c; }
    .swatch-actual    { background: #1abc9c; }
    .swatch-bust      { background: #e74c3c; }
    .tooltip-close {
      margin-top: 1rem;
      background: transparent;
      border: 1px solid var(--gold-dim);
      color: var(--text-dim);
      padding: 0.35rem 1rem;
      cursor: pointer;
      border-radius: 4px;
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.6rem;
      letter-spacing: 0.05em;
      transition: all 0.2s;
    }
    .tooltip-close:hover { color: var(--gold); border-color: var(--gold); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LIVE DEBT / COULD-HAVE-BOUGHT PANEL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #live-debt-panel {
      background: rgba(5,8,5,0.8);
      border: 1px solid rgba(192,57,43,0.25);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin: 0.5rem 0;
      display: none;
    }
    #live-debt-panel.visible { display: block; }

    .ldp-header {
      display: flex;
      align-items: baseline;
      gap: 0.75rem;
      margin-bottom: 0.6rem;
    }
    .ldp-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.55rem;
      letter-spacing: 0.15em;
      color: var(--debt-col);
      opacity: 0.8;
    }
    .ldp-amount {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 1.35rem;
      color: var(--debt-col);
      transition: all 0.4s;
      line-height: 1;
    }
    .ldp-amount.pop {
      animation: amountPop 0.35s ease-out;
    }
    @keyframes amountPop {
      0%   { transform: scale(1); }
      40%  { transform: scale(1.18); }
      100% { transform: scale(1); }
    }

    .ldp-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .ldp-item {
      background: rgba(201,168,76,0.06);
      border: 1px solid rgba(201,168,76,0.15);
      border-radius: 4px;
      padding: 0.22rem 0.55rem;
      font-size: 0.78rem;
      color: var(--text-dim);
      font-style: italic;
      animation: itemAppear 0.3s ease-out;
    }
    @keyframes itemAppear {
      from { transform: scale(0.85); opacity: 0; }
      to   { transform: scale(1); opacity: 1; }
    }

    /* Emphasise biggest item */
    .ldp-item.hero {
      background: rgba(201,168,76,0.1);
      border-color: rgba(201,168,76,0.3);
      color: var(--text);
      font-size: 0.85rem;
    }

    /* No-debt state */
    .ldp-ok {
      font-size: 0.82rem;
      font-style: italic;
      color: var(--win-col);
      opacity: 0.7;
    }

    /* Bigger items list in game-over report */
    .buy-item-big {
      background: rgba(201,168,76,0.07);
      border: 1px solid rgba(201,168,76,0.2);
      border-radius: 6px;
      padding: 0.5rem 0.9rem;
      font-size: 0.9rem;
      color: var(--text-dim);
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .buy-item-big .bi-emoji { font-size: 1.3rem; }
    .buy-item-big .bi-qty {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.55rem;
      color: var(--gold);
      opacity: 0.7;
      display: block;
      margin-top: 0.1rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       NEXT-HAND FORECAST PANEL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #next-hand-forecast {
      background: rgba(5,8,5,0.9);
      border: 1px solid rgba(192,57,43,0.35);
      border-radius: 10px;
      padding: 1.2rem 1.4rem;
      max-width: 480px;
      width: 100%;
      margin-top: 0.85rem;
      position: relative;
      overflow: hidden;
    }

    /* Subtle red vignette to signal "warning" */
    #next-hand-forecast::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 50% 0%, rgba(192,57,43,0.08), transparent 70%);
      pointer-events: none;
    }

    .nhf-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.62rem;
      letter-spacing: 0.15em;
      color: var(--debt-col);
      opacity: 0.85;
      margin-bottom: 1rem;
      text-align: center;
    }

    /* Big loss-probability display */
    .nhf-prob-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.9rem;
    }

    .nhf-prob-circle {
      position: relative;
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }

    .nhf-prob-circle svg {
      width: 80px;
      height: 80px;
      transform: rotate(-90deg);
    }

    .nhf-circle-track {
      fill: none;
      stroke: rgba(255,255,255,0.06);
      stroke-width: 7;
    }

    .nhf-circle-fill {
      fill: none;
      stroke: var(--debt-col);
      stroke-width: 7;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.8s cubic-bezier(0.4,0,0.2,1);
    }

    .nhf-circle-fill.mid   { stroke: #e67e22; }
    .nhf-circle-fill.low   { stroke: #f1c40f; }

    .nhf-prob-label {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .nhf-prob-number {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 1.2rem;
      line-height: 1;
      color: var(--debt-col);
      transition: color 0.5s;
    }
    .nhf-prob-number.mid { color: #e67e22; }
    .nhf-prob-number.low { color: #f1c40f; }

    .nhf-prob-unit {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.4rem;
      opacity: 0.6;
      letter-spacing: 0.1em;
    }

    .nhf-prob-text {
      flex: 1;
    }

    .nhf-prob-headline {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.78rem;
      color: var(--text);
      margin-bottom: 0.35rem;
      line-height: 1.4;
    }

    .nhf-prob-sub {
      font-size: 0.8rem;
      font-style: italic;
      color: var(--text-dim);
      line-height: 1.5;
    }

    /* Context bars: Your session vs. statistical baseline */
    .nhf-context {
      border-top: 1px solid rgba(255,255,255,0.05);
      padding-top: 0.75rem;
      margin-bottom: 0.85rem;
    }

    .nhf-context-row {
      display: grid;
      grid-template-columns: 100px 1fr 44px;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }
    .nhf-context-row:last-child { margin-bottom: 0; }

    .nhf-ctx-lbl {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.43rem;
      letter-spacing: 0.08em;
      color: var(--text-dim);
    }

    .nhf-bar-track {
      height: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 3px;
      overflow: hidden;
    }

    .nhf-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.7s cubic-bezier(0.4,0,0.2,1);
    }

    .nhf-bar-session  { background: linear-gradient(90deg, #e74c3c, #c0392b); }
    .nhf-bar-baseline { background: linear-gradient(90deg, #7f8c8d, #95a5a6); }
    .nhf-bar-long     { background: linear-gradient(90deg, #8e44ad, #6c3483); }

    .nhf-ctx-val {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.65rem;
      text-align: right;
      color: var(--text-dim);
    }

    /* Dissuasion message */
    .nhf-message {
      background: rgba(192,57,43,0.07);
      border-left: 3px solid rgba(192,57,43,0.5);
      border-radius: 0 5px 5px 0;
      padding: 0.65rem 0.85rem;
      font-size: 0.88rem;
      font-style: italic;
      color: var(--text-dim);
      line-height: 1.6;
      margin-bottom: 0.75rem;
    }

    .nhf-message strong {
      color: var(--text);
      font-style: normal;
    }

    /* Walk-away CTA */
    .nhf-cta {
      display: flex;
      gap: 0.6rem;
      justify-content: center;
    }

    .nhf-walk-away {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.68rem;
      padding: 0.55rem 1.4rem;
      background: linear-gradient(135deg, rgba(192,57,43,0.15), rgba(192,57,43,0.08));
      border: 1px solid rgba(192,57,43,0.45);
      color: #e8b4af;
      border-radius: 4px;
      cursor: pointer;
      letter-spacing: 0.05em;
      transition: all 0.2s;
      clip-path: polygon(5px 0%, calc(100% - 5px) 0%, 100% 5px, 100% calc(100% - 5px), calc(100% - 5px) 100%, 5px 100%, 0% calc(100% - 5px), 0% 5px);
    }
    .nhf-walk-away:hover {
      background: rgba(192,57,43,0.25);
      border-color: rgba(192,57,43,0.7);
      color: #ffd5d0;
    }

    /* Expected-loss projection */
    .nhf-projection {
      margin-top: 0.6rem;
      font-size: 0.75rem;
      color: var(--text-dim);
      text-align: center;
      font-style: italic;
      opacity: 0.7;
    }
    .nhf-projection strong { color: var(--debt-col); font-style: normal; }
  </style>
</head>
<body>

<!-- ANTI-GAMBLING HUD -->
<div id="ag-hud">
  <div class="ag-block">
    <span class="ag-lbl">SESSION</span>
    <span class="ag-val" id="hud-timer">00:00</span>
  </div>
  <div class="ag-block">
    <span class="ag-lbl">NET P/L</span>
    <span class="ag-val" id="hud-debt">$0</span>
  </div>
  <div class="ag-block">
    <span class="ag-lbl">WIN RATE</span>
    <span class="ag-val" id="hud-winrate">â€”</span>
  </div>
  <div class="ag-block">
    <span class="ag-lbl">HANDS</span>
    <span class="ag-val" id="hud-hands">0</span>
  </div>
  <div class="ag-block" title="The statistical advantage the house holds over the player in standard blackjack">
    <span class="ag-lbl">HOUSE EDGE</span>
    <span class="ag-val hud-house">~0.5%</span>
  </div>
</div>

<!-- STREAK / TIME BANNERS -->
<div id="banner-streak" class="ag-banner streak">
  âš ï¸ <strong>3 losses in a row.</strong> Chasing losses is the most common gambling trap â€” the odds don't change.
</div>
<div id="banner-time" class="ag-banner time-warn">
  â± You've been playing for 30 minutes. Studies show risk tolerance increases with session length. Consider a break.
</div>

<!-- MAIN GAME -->
<div id="game-wrap">
  <div style="display:flex; align-items:center; justify-content:space-between; padding-top:1rem;">
    <button class="btn btn-back" onclick="window.location.href='../index.html'">â† MAIN MENU</button>
    <span style="font-family:'Cinzel Decorative',cursive; font-size:0.7rem; color:var(--text-dim); letter-spacing:0.1em;">REALISTIC BLACKJACK</span>
    <div style="width:90px"></div>
  </div>

  <!-- DEALER -->
  <div id="dealer-zone">
    <div class="zone-label">â–² DEALER</div>
    <div class="hand-score" id="dealer-score">â€”</div>
    <div class="card-row" id="dealer-cards"></div>
  </div>

  <hr id="table-divider">

  <!-- MESSAGE -->
  <div id="msg-box">Place your bet and deal to begin.</div>


  <!-- ODDS TRACKER -->
  <div id="odds-panel">
    <div class="odds-header">
      <span class="odds-title">ğŸ² ODDS TRACKER</span>
      <button class="odds-info-btn" onclick="document.getElementById('odds-tooltip').classList.add('show')" title="How is this calculated?">?</button>
    </div>
    <div class="odds-row">
      <span class="odds-lbl">YOU FEEL</span>
      <div class="odds-bar-track"><div class="odds-bar-fill bar-perceived" id="bar-perceived" style="width:0%"></div></div>
      <span class="odds-pct pct-perceived" id="pct-perceived">â€”</span>
    </div>
    <div class="odds-row">
      <span class="odds-lbl">ACTUAL WIN %</span>
      <div class="odds-bar-track"><div class="odds-bar-fill bar-actual" id="bar-actual" style="width:0%"></div></div>
      <span class="odds-pct pct-actual" id="pct-actual">â€”</span>
    </div>
    <div class="odds-row">
      <span class="odds-lbl">BUST RISK</span>
      <div class="odds-bar-track"><div class="odds-bar-fill bar-bust" id="bar-bust" style="width:0%"></div></div>
      <span class="odds-pct pct-bust" id="pct-bust">â€”</span>
    </div>
    <div class="odds-gap" id="odds-gap"></div>
  </div>

  <!-- LIVE DEBT / COULD-HAVE-BOUGHT -->
  <div id="live-debt-panel">
    <div class="ldp-header">
      <span class="ldp-title">TOTAL LOST</span>
      <span class="ldp-amount" id="ldp-amount">$0</span>
    </div>
    <div class="ldp-items" id="ldp-items"></div>
  </div>

  <!-- PLAYER -->
  <div id="player-zone">
    <div class="zone-label">â–¼ YOUR HAND</div>
    <div class="hand-score" id="player-score">â€”</div>
    <div class="card-row" id="player-cards"></div>

    <!-- CHIPS + BET -->
    <div id="bet-row">
      <div class="balance-display">BALANCE <span id="balance-display">$500</span></div>
      <button class="chip chip-1"   onclick="addBet(1)"   id="chip1">$1</button>
      <button class="chip chip-5"   onclick="addBet(5)"   id="chip5">$5</button>
      <button class="chip chip-25"  onclick="addBet(25)"  id="chip25">$25</button>
      <button class="chip chip-100" onclick="addBet(100)" id="chip100">$100</button>
      <button class="chip chip-500" onclick="addBet(500)" id="chip500">$500</button>
      <div id="current-bet-display">BET <span id="bet-display">$0</span></div>
    </div>

    <!-- ACTIONS -->
    <div id="action-row">
      <button class="btn btn-clear" id="btn-clear" onclick="clearBet()">CLEAR</button>
      <button class="btn btn-deal"  id="btn-deal"  onclick="deal()">DEAL</button>
      <button class="btn btn-hit"   id="btn-hit"   onclick="hit()"    disabled>HIT</button>
      <button class="btn btn-stand" id="btn-stand" onclick="stand()"  disabled>STAND</button>
      <button class="btn btn-double"id="btn-double"onclick="doubleDown()" disabled>DOUBLE</button>
    </div>
  </div>
</div>

<!-- FLASH -->
<div id="flash"></div>

<!-- WIN NUDGE -->
<div id="win-nudge">
  <div class="nudge-box">
    <div style="font-size:2rem">ğŸ†</div>
    <div class="nudge-title">You're running hot!</div>
    <div class="nudge-body">
      A winning streak feels powerful â€” but the house edge never changes.<br>
      This is statistically one of the best moments to walk away.
    </div>
    <button class="nudge-dismiss" onclick="document.getElementById('win-nudge').classList.remove('show')">
      KEEP PLAYING ANYWAY
    </button>
  </div>
</div>

<!-- GAME OVER / BUST OVERLAY (hand result) â€” reused each hand -->
<div id="gameover">
  <div id="go-title"></div>
  <div id="go-subtitle" style="font-style:italic; opacity:0.7; margin-top:0.3rem; font-size:1rem;"></div>

  <div id="report">
    <div class="report-title">ğŸ“Š SESSION REALITY CHECK</div>
    <div class="report-grid">
      <div class="r-stat">
        <div class="r-stat-lbl">TIME PLAYED</div>
        <div class="r-stat-val" id="r-time">â€”</div>
      </div>
      <div class="r-stat">
        <div class="r-stat-lbl">HANDS PLAYED</div>
        <div class="r-stat-val" id="r-hands">â€”</div>
      </div>
      <div class="r-stat">
        <div class="r-stat-lbl">HANDS WON</div>
        <div class="r-stat-val" id="r-wins">â€”</div>
      </div>
      <div class="r-stat">
        <div class="r-stat-lbl">WIN RATE</div>
        <div class="r-stat-val" id="r-winrate">â€”</div>
      </div>
    </div>

    <div class="debt-box" id="r-debt-box">
      <div class="debt-box-lbl" id="r-debt-lbl">NET LOSS THIS SESSION</div>
      <div class="debt-box-amount" id="r-debt-amount">$0</div>
    </div>

    <div class="could-buy" id="r-couldbuy" style="display:none">
      <div class="could-buy-title">ğŸ›’ INSTEAD, YOU COULD HAVE BOUGHT...</div>
      <div class="buy-list" id="r-buy-list"></div>
    </div>

    <div class="report-reminder">
      The house edge in blackjack is ~0.5% with perfect basic strategy â€” most players lose more than that.
      No streak, hot shoe, or intuition changes the math.
      <a class="helpline" href="https://www.ncpgambling.org/help-treatment/national-helpline-1-800-522-4700/" target="_blank">
        ğŸ†˜ National Problem Gambling Helpline: 1-800-522-4700
      </a>
    </div>
  </div>


  <!-- NEXT-HAND FORECAST -->
  <div id="next-hand-forecast">
    <div class="nhf-title">ğŸ“‰ NEXT HAND FORECAST</div>

    <div class="nhf-prob-row">
      <div class="nhf-prob-circle">
        <svg viewBox="0 0 80 80">
          <circle class="nhf-circle-track" cx="40" cy="40" r="33"/>
          <circle class="nhf-circle-fill" id="nhf-circle-fill" cx="40" cy="40" r="33"
            stroke-dasharray="207.3"
            stroke-dashoffset="207.3"/>
        </svg>
        <div class="nhf-prob-label">
          <span class="nhf-prob-number" id="nhf-prob-number">â€”</span>
          <span class="nhf-prob-unit">LOSE %</span>
        </div>
      </div>
      <div class="nhf-prob-text">
        <div class="nhf-prob-headline" id="nhf-headline">Calculating oddsâ€¦</div>
        <div class="nhf-prob-sub" id="nhf-sub"></div>
      </div>
    </div>

    <div class="nhf-context">
      <div class="nhf-context-row">
        <span class="nhf-ctx-lbl">YOUR SESSION</span>
        <div class="nhf-bar-track"><div class="nhf-bar-fill nhf-bar-session" id="nhf-bar-session" style="width:0%"></div></div>
        <span class="nhf-ctx-val" id="nhf-val-session">â€”</span>
      </div>
      <div class="nhf-context-row">
        <span class="nhf-ctx-lbl">STATISTICAL BASE</span>
        <div class="nhf-bar-track"><div class="nhf-bar-fill nhf-bar-baseline" style="width:49%"></div></div>
        <span class="nhf-ctx-val">49%</span>
      </div>
      <div class="nhf-context-row">
        <span class="nhf-ctx-lbl">LONG-RUN (1000 hands)</span>
        <div class="nhf-bar-track"><div class="nhf-bar-fill nhf-bar-long" style="width:55%"></div></div>
        <span class="nhf-ctx-val">55%</span>
      </div>
    </div>

    <div class="nhf-message" id="nhf-message"></div>

    <div class="nhf-cta">
      <button class="nhf-walk-away" onclick="window.location.href='../index.html'">ğŸšª WALK AWAY NOW</button>
    </div>

    <div class="nhf-projection" id="nhf-projection"></div>
  </div>

  <div class="go-btns">
    <button class="btn-lg btn-lg-gold"  onclick="newHand()">DEAL AGAIN</button>
    <button class="btn-lg btn-lg-muted" onclick="window.location.href='../index.html'">MAIN MENU</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BLACKJACK ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SUITS  = ['â™ ','â™¥','â™¦','â™£'];
const VALUES = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const RED_SUITS = new Set(['â™¥','â™¦']);
const DEALER_HITS_SOFT_17 = true; // H17 â€” standard Vegas rule

let deck = [], dealerCards = [], playerCards = [];
let phase = 'bet'; // 'bet' | 'player' | 'dealer' | 'done'
let currentBet = 0;
let balance = 500;

function freshDeck(numDecks = 6) {
  let d = [];
  for (let n = 0; n < numDecks; n++)
    for (let s of SUITS) for (let v of VALUES) d.push({ suit: s, value: v });
  for (let i = d.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [d[i], d[j]] = [d[j], d[i]];
  }
  return d;
}

function cardVal(card) {
  if (['J','Q','K'].includes(card.value)) return 10;
  if (card.value === 'A') return 11;
  return parseInt(card.value);
}

function handTotal(cards) {
  let total = 0, aces = 0;
  for (const c of cards) { total += cardVal(c); if (c.value === 'A') aces++; }
  while (total > 21 && aces > 0) { total -= 10; aces--; }
  return total;
}

function isSoft17(cards) {
  let total = 0, aces = 0;
  for (const c of cards) { total += cardVal(c); if (c.value === 'A') aces++; }
  while (total > 21 && aces > 0) { total -= 10; aces--; }
  if (total !== 17) return false;
  let base = 0;
  for (const c of cards) base += c.value === 'A' ? 1 : cardVal(c);
  return total > base;
}

function isBlackjack(cards) {
  return cards.length === 2 && handTotal(cards) === 21;
}

// â”€â”€â”€ RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderCard(card, container, faceDown = false) {
  const isRed = RED_SUITS.has(card.suit);
  const div = document.createElement('div');
  div.className = 'card';
  if (faceDown) {
    div.innerHTML = `<div class="card-inner"><div class="card-back"></div></div>`;
  } else {
    div.innerHTML = `
      <div class="card-inner">
        <div class="card-face ${isRed ? 'red' : 'black'}">
          <div class="corner tl">${card.value}<br>${card.suit}</div>
          <div class="center-suit">${card.suit}</div>
          <div class="corner br">${card.value}<br>${card.suit}</div>
        </div>
      </div>`;
  }
  div._card = card;
  container.appendChild(div);
  return div;
}

function flipCard(div) {
  const card = div._card;
  const isRed = RED_SUITS.has(card.suit);
  div.classList.add('flip');
  setTimeout(() => {
    div.innerHTML = `
      <div class="card-inner">
        <div class="card-face ${isRed ? 'red' : 'black'}">
          <div class="corner tl">${card.value}<br>${card.suit}</div>
          <div class="center-suit">${card.suit}</div>
          <div class="corner br">${card.value}<br>${card.suit}</div>
        </div>
      </div>`;
  }, 225);
}

function updateScores(revealDealer = false) {
  const ps = handTotal(playerCards);
  document.getElementById('player-score').textContent = ps > 21 ? `${ps} â€” BUST` : ps;
  if (revealDealer) {
    const ds = handTotal(dealerCards);
    document.getElementById('dealer-score').textContent = ds > 21 ? `${ds} â€” BUST` : ds;
  } else {
    // Show only first visible card total
    if (dealerCards.length > 0) {
      document.getElementById('dealer-score').textContent = cardVal(dealerCards[0]);
    }
  }
}

function setMsg(text) { document.getElementById('msg-box').textContent = text; }

function flash(color) {
  const el = document.getElementById('flash');
  el.style.background = color;
  el.style.opacity = '0.2';
  setTimeout(() => el.style.opacity = '0', 160);
}

// â”€â”€â”€ BETTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addBet(amount) {
  if (phase !== 'bet') return;
  if (currentBet + amount > balance) return;
  currentBet += amount;
  document.getElementById('bet-display').textContent = `$${currentBet}`;
  updateBetButtons();
}

function clearBet() {
  if (phase !== 'bet') return;
  currentBet = 0;
  document.getElementById('bet-display').textContent = '$0';
  updateBetButtons();
}

function updateBetButtons() {
  document.getElementById('btn-deal').disabled = (currentBet === 0);
  document.getElementById('btn-clear').disabled = (currentBet === 0);
  const chips = ['chip1','chip5','chip25','chip100','chip500'];
  const amounts = [1,5,25,100,500];
  chips.forEach((id, i) => {
    document.getElementById(id).disabled = (phase !== 'bet' || currentBet + amounts[i] > balance);
  });
  document.getElementById('balance-display').textContent = `$${balance}`;
}

// â”€â”€â”€ DEAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function deal() {
  if (currentBet === 0 || phase !== 'bet') return;
  if (deck.length < 30) deck = freshDeck(6);

  // Deduct bet
  balance -= currentBet;
  updateBetButtons();
  agHandStart();

  // Clear tables
  document.getElementById('dealer-cards').innerHTML = '';
  document.getElementById('player-cards').innerHTML = '';
  dealerCards = [];
  playerCards = [];
  document.getElementById('dealer-score').textContent = 'â€”';
  document.getElementById('player-score').textContent = 'â€”';

  // Disable bet buttons
  setPhase('deal-anim');

  // Deal sequence: p1, d1, p2, d2(face-down)
  await dealCardTo('player', false, 0);
  await dealCardTo('dealer', false, 250);
  await dealCardTo('player', false, 500);
  await dealCardTo('dealer', true,  750);   // hole card

  await sleep(900);
  updateScores(false);

  // Check naturals
  const pBJ = isBlackjack(playerCards);
  const dBJ = isBlackjack(dealerCards);

  if (pBJ || dBJ) {
    revealHole();
    updateScores(true);
    await sleep(700);
    if (pBJ && dBJ) { settleHand('push', 'Both Blackjack â€” Push'); }
    else if (pBJ)   { settleHand('blackjack', 'Blackjack! 3:2 payout'); }
    else            { settleHand('lose', 'Dealer Blackjack'); }
    return;
  }

  // Player's turn
  setPhase('player');
  const canDouble = (balance >= currentBet);
  document.getElementById('btn-double').disabled = !canDouble;
  setMsg('Your move: Hit, Stand, or Double Down.');
  updateOddsPanel();
}

async function dealCardTo(target, faceDown, delay) {
  await sleep(delay);
  const card = deck.pop();
  if (target === 'player') playerCards.push(card);
  else dealerCards.push(card);
  const container = document.getElementById(target === 'player' ? 'player-cards' : 'dealer-cards');
  const div = renderCard(card, container, faceDown);
  div._faceDown = faceDown;
  return div;
}

function revealHole() {
  const container = document.getElementById('dealer-cards');
  const cards = container.querySelectorAll('.card');
  cards.forEach((div, i) => {
    if (div._faceDown) { flipCard(div); div._faceDown = false; }
  });
}

// â”€â”€â”€ PLAYER ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function hit() {
  if (phase !== 'player') return;
  const card = deck.pop();
  playerCards.push(card);
  renderCard(card, document.getElementById('player-cards'), false);
  updateScores(false);
  updateOddsPanel();
  if (handTotal(playerCards) > 21) {
    setMsg('Bust! You went over 21.');
    flash('#c0392b');
    settleHand('bust', 'Bust â€” over 21');
  } else if (handTotal(playerCards) === 21) {
    stand(); // auto-stand on 21
  }
}

function stand() {
  if (phase !== 'player') return;
  setPhase('dealer');
  setMsg('Dealer revealsâ€¦');
  revealHole();
  updateScores(true);
  setTimeout(dealerPlay, 700);
}

function doubleDown() {
  if (phase !== 'player' || balance < currentBet) return;
  balance -= currentBet;
  currentBet *= 2;
  document.getElementById('bet-display').textContent = `$${currentBet}`;
  updateBetButtons();
  const card = deck.pop();
  playerCards.push(card);
  renderCard(card, document.getElementById('player-cards'), false);
  updateScores(false);
  if (handTotal(playerCards) > 21) {
    revealHole();
    settleHand('bust', 'Doubled â€” Bust');
  } else {
    stand();
  }
}

// â”€â”€â”€ DEALER PLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function dealerPlay() {
  let total = handTotal(dealerCards);
  while (total < 17 || (DEALER_HITS_SOFT_17 && total === 17 && isSoft17(dealerCards))) {
    await sleep(650);
    const card = deck.pop();
    dealerCards.push(card);
    renderCard(card, document.getElementById('dealer-cards'), false);
    total = handTotal(dealerCards);
    updateScores(true);
  }

  await sleep(500);
  const pTotal = handTotal(playerCards);
  const dTotal = handTotal(dealerCards);

  if (dTotal > 21)         settleHand('win',  `Dealer busts at ${dTotal}!`);
  else if (pTotal > dTotal) settleHand('win',  `${pTotal} beats ${dTotal}`);
  else if (dTotal > pTotal) settleHand('lose', `Dealer ${dTotal} beats your ${pTotal}`);
  else                      settleHand('push', `Both ${pTotal} â€” Push`);
}

// â”€â”€â”€ SETTLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function settleHand(result, subtitle) {
  setPhase('done');
  let payout = 0;
  let agResult = 'loss';

  if (result === 'win')       { payout = currentBet * 2; agResult = 'win'; }
  else if (result === 'blackjack') { payout = Math.floor(currentBet * 2.5); agResult = 'win'; }
  else if (result === 'push') { payout = currentBet; agResult = 'push'; }
  else                        { payout = 0; agResult = 'loss'; }

  balance += payout;
  const netChange = payout - currentBet;

  // Flash feedback
  if (result === 'win' || result === 'blackjack') flash('#27ae60');
  else if (result === 'lose' || result === 'bust') flash('#c0392b');

  agRecordHand(agResult, Math.abs(netChange));
  updateLiveDebtPanel();
  document.getElementById('odds-panel').classList.remove('visible');

  // Show game-over report overlay
  const title = document.getElementById('go-title');
  if (result === 'win' || result === 'blackjack') {
    title.textContent = result === 'blackjack' ? 'â™  BLACKJACK â™ ' : 'âœ“ YOU WIN';
    title.className = 'go-win';
  } else if (result === 'lose' || result === 'bust') {
    title.textContent = result === 'bust' ? 'âœ— BUST' : 'âœ— YOU LOSE';
    title.className = 'go-lose';
  } else {
    title.textContent = 'â€” PUSH â€”';
    title.className = 'go-push';
  }
  document.getElementById('go-subtitle').textContent = subtitle;

  buildReport();
  buildNextHandForecast();
  // Store last bet for forecast reference
  AG.lastBet = currentBet;
  document.getElementById('gameover').classList.add('show');
}

function newHand() {
  document.getElementById('gameover').classList.remove('show');
  if (balance === 0) {
    alert("You're out of chips! Session ending.");
    window.location.href = 'index.html';
    return;
  }
  currentBet = 0;
  document.getElementById('bet-display').textContent = '$0';
  setPhase('bet');
  setMsg('Place your bet and deal to begin.');
  updateBetButtons();
}

function setPhase(p) {
  phase = p;
  const inBet    = (p === 'bet');
  const inPlayer = (p === 'player');
  document.getElementById('btn-deal').disabled   = (p !== 'bet' || currentBet === 0);
  document.getElementById('btn-clear').disabled  = (p !== 'bet');
  document.getElementById('btn-hit').disabled    = !inPlayer;
  document.getElementById('btn-stand').disabled  = !inPlayer;
  document.getElementById('btn-double').disabled = !inPlayer;
  ['chip1','chip5','chip25','chip100','chip500'].forEach(id => {
    document.getElementById(id).disabled = !inBet;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANTI-GAMBLING SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const AG = {
  sessionStart: Date.now(),
  timerInterval: null,
  hands: 0,
  wins: 0,
  pushes: 0,
  losses: 0,
  consecutiveLosses: 0,
  consecutiveWins: 0,
  netPL: 0,          // positive = profit, negative = loss
  totalWagered: 0,
  totalLost: 0,       // gross losses only (for could-have-bought)
  warnedTime: false,
};

function agInit() {
  AG.sessionStart = Date.now();
  AG.timerInterval = setInterval(agTick, 1000);
  agTick();
}

function agHandStart() {
  AG.totalWagered += currentBet;
}

function agTick() {
  const elapsed = Math.floor((Date.now() - AG.sessionStart) / 1000);
  const mm = String(Math.floor(elapsed / 60)).padStart(2,'0');
  const ss = String(elapsed % 60).padStart(2,'0');
  const el = document.getElementById('hud-timer');
  el.textContent = `${mm}:${ss}`;

  if (elapsed >= 1800 && !AG.warnedTime) {
    AG.warnedTime = true;
    document.getElementById('banner-time').classList.add('show');
    el.className = 'ag-val warn-red';
  } else if (elapsed >= 900) {
    el.className = 'ag-val warn-orange';
  }
}

function agRecordHand(result, moneyMoved) {
  AG.hands++;
  document.getElementById('hud-hands').textContent = AG.hands;

  if (result === 'win') {
    AG.wins++;
    AG.consecutiveLosses = 0;
    AG.consecutiveWins++;
    AG.netPL += moneyMoved;
    document.getElementById('banner-streak').classList.remove('show');
    if (AG.consecutiveWins >= 3) {
      document.getElementById('win-nudge').classList.add('show');
      AG.consecutiveWins = 0;
    }
  } else if (result === 'loss') {
    AG.losses++;
    AG.consecutiveWins = 0;
    AG.consecutiveLosses++;
    AG.netPL -= moneyMoved;
    AG.totalLost += moneyMoved;
    if (AG.consecutiveLosses >= 3) {
      document.getElementById('banner-streak').classList.add('show');
    }
  } else {
    // push
    AG.pushes++;
    AG.consecutiveLosses = 0;
    AG.consecutiveWins = 0;
  }

  // Update HUD P/L
  const debtEl = document.getElementById('hud-debt');
  if (AG.netPL > 0) {
    debtEl.textContent = `+$${AG.netPL}`;
    debtEl.className = 'ag-val in-profit';
  } else if (AG.netPL < 0) {
    debtEl.textContent = `-$${Math.abs(AG.netPL)}`;
    debtEl.className = 'ag-val in-debt';
  } else {
    debtEl.textContent = '$0';
    debtEl.className = 'ag-val';
  }

  // Update win rate
  const played = AG.wins + AG.losses;
  const wrEl = document.getElementById('hud-winrate');
  if (played > 0) {
    const rate = Math.round((AG.wins / played) * 100);
    wrEl.textContent = `${rate}%`;
    wrEl.className = rate >= 50 ? 'ag-val winning' : 'ag-val losing';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUYABLE ITEMS DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// [emoji, name, price, category]
const BUYABLE = [
  ['â˜•', 'Cup of coffee',          5,   'food'],
  ['ğŸŒ®', 'Taco',                   3,   'food'],
  ['ğŸ•', 'Pizza slice',            4,   'food'],
  ['ğŸ”', 'Burger meal',            9,   'food'],
  ['ğŸ§‹', 'Bubble tea',             7,   'food'],
  ['ğŸ¦', 'Ice cream cone',         4,   'food'],
  ['ğŸ¥', 'Croissant',              3,   'food'],
  ['ğŸŒ¯', 'Burrito',                9,   'food'],
  ['ğŸ§', 'Cupcake',                4,   'food'],
  ['ğŸ¿', 'Movie popcorn',          8,   'food'],
  ['ğŸ¬', 'Movie ticket',          14,   'entertainment'],
  ['ğŸ“š', 'Paperback book',        12,   'entertainment'],
  ['ğŸ®', 'Indie Steam game',      10,   'entertainment'],
  ['ğŸ§', 'Spotify month',         11,   'entertainment'],
  ['ğŸŸï¸', 'Concert ticket',        35,   'entertainment'],
  ['ğŸ²', 'Board game',            25,   'entertainment'],
  ['ğŸ¨', 'Sketchbook + pens',     18,   'entertainment'],
  ['ğŸŒ»', 'Bunch of flowers',      10,   'lifestyle'],
  ['ğŸ›', 'Fancy bath bomb',       12,   'lifestyle'],
  ['ğŸ“±', 'Phone case',            15,   'lifestyle'],
  ['ğŸ', 'Birthday gift',         20,   'lifestyle'],
  ['ğŸ‹ï¸', 'Gym day pass',          15,   'lifestyle'],
  ['ğŸšŒ', 'Bus day pass',           3,   'lifestyle'],
  ['ğŸŒ¿', 'Houseplant',            12,   'lifestyle'],
  ['ğŸ•¯ï¸', 'Scented candle',        14,   'lifestyle'],
  ['â˜€ï¸', 'Sunscreen (SPF 50)',     10,   'lifestyle'],
  ['ğŸ’Š', 'Multivitamins (month)', 15,   'lifestyle'],
  ['ğŸ·', 'Decent bottle of wine',  18,  'lifestyle'],
  ['ğŸª', 'Theme park entry',      60,   'experience'],
  ['âœˆï¸', 'Budget flight (one-way)',80,  'experience'],
  ['ğŸ¨', 'Hostel night',          40,   'experience'],
  ['ğŸ­', 'Theatre ticket',        50,   'experience'],
  ['ğŸš´', 'Bike rental (day)',      25,   'experience'],
];

// Arrange items in tiers for smarter selection
function buildCouldHaveBought(totalLost, containerEl, style='compact') {
  containerEl.innerHTML = '';
  if (totalLost < 3) return;

  // Sort by price descending, pick biggest fitting items first
  const sorted = [...BUYABLE].sort((a, b) => b[2] - a[2]);
  let budget = totalLost;
  const chosen = [];

  // First pass: try to find a few impactful items
  for (const item of sorted) {
    if (budget <= 0 || chosen.length >= 5) break;
    if (item[2] <= budget) {
      const maxQty = Math.min(Math.floor(budget / item[2]), 4);
      const qty = maxQty;
      budget -= qty * item[2];
      chosen.push({ emoji: item[0], name: item[1], price: item[2], qty });
    }
  }

  chosen.forEach((item, idx) => {
    const el = document.createElement('div');
    if (style === 'compact') {
      el.className = idx === 0 ? 'ldp-item hero' : 'ldp-item';
      el.textContent = `${item.emoji} ${item.qty > 1 ? item.qty + 'Ã— ' : ''}${item.name}`;
    } else {
      // big style for report overlay
      el.className = 'buy-item-big';
      el.innerHTML = `
        <span class="bi-emoji">${item.emoji}</span>
        <span>
          ${item.qty > 1 ? item.qty + 'Ã— ' : ''}${item.name}
          <span class="bi-qty">$${item.price * item.qty}</span>
        </span>`;
    }
    containerEl.appendChild(el);
  });
}

// â”€â”€ Live debt panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLiveDebtPanel() {
  const panel = document.getElementById('live-debt-panel');
  const amtEl = document.getElementById('ldp-amount');
  const itemsEl = document.getElementById('ldp-items');
  const loss = AG.totalLost;

  if (loss <= 0) {
    panel.classList.remove('visible');
    return;
  }

  panel.classList.add('visible');

  // Animate number change
  const prev = amtEl.dataset.prev || '0';
  amtEl.textContent = `$${loss}`;
  if (prev !== String(loss)) {
    amtEl.classList.remove('pop');
    void amtEl.offsetWidth;
    amtEl.classList.add('pop');
    amtEl.dataset.prev = loss;
  }

  buildCouldHaveBought(loss, itemsEl, 'compact');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ODDS TRACKER ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ACTUAL WIN % â€” derived from published basic strategy expected values.
 * Returns approximate win probability given player total and dealer upcard.
 * Based on standard 6-deck, H17 tables (Wizard of Odds / Griffin).
 *
 * Table format: playerTotal -> { dealerUpcardValue: winPct }
 * Dealer upcard 1 = Ace
 */
const BASIC_STRATEGY_WIN_PCT = {
  // Player hard totals
  4:  { 2:41, 3:42, 4:44, 5:46, 6:46, 7:40, 8:38, 9:35, 10:33, 1:30 },
  5:  { 2:41, 3:42, 4:44, 5:46, 6:46, 7:40, 8:38, 9:35, 10:33, 1:30 },
  6:  { 2:41, 3:42, 4:44, 5:46, 6:46, 7:40, 8:38, 9:35, 10:33, 1:30 },
  7:  { 2:41, 3:43, 4:45, 5:46, 6:47, 7:41, 8:39, 9:36, 10:34, 1:31 },
  8:  { 2:42, 3:43, 4:46, 5:47, 6:47, 7:42, 8:40, 9:37, 10:34, 1:31 },
  9:  { 2:44, 3:46, 4:48, 5:50, 6:50, 7:42, 8:40, 9:37, 10:34, 1:31 },
  10: { 2:54, 3:56, 4:58, 5:60, 6:60, 7:53, 8:50, 9:46, 10:40, 1:36 },
  11: { 2:57, 3:58, 4:60, 5:62, 6:62, 7:55, 8:52, 9:48, 10:41, 1:38 },
  12: { 2:36, 3:38, 4:41, 5:43, 6:43, 7:40, 8:38, 9:35, 10:33, 1:30 },
  13: { 2:38, 3:40, 4:43, 5:45, 6:46, 7:40, 8:37, 9:34, 10:31, 1:29 },
  14: { 2:39, 3:41, 4:44, 5:46, 6:47, 7:40, 8:37, 9:34, 10:31, 1:29 },
  15: { 2:39, 3:41, 4:44, 5:46, 6:47, 7:39, 8:36, 9:33, 10:28, 1:27 },
  16: { 2:39, 3:41, 4:43, 5:45, 6:46, 7:38, 8:35, 9:31, 10:27, 1:26 },
  17: { 2:41, 3:43, 4:45, 5:47, 6:47, 7:44, 8:41, 9:37, 10:32, 1:30 },
  18: { 2:56, 3:57, 4:59, 5:60, 6:61, 7:58, 8:53, 9:45, 10:40, 1:38 },
  19: { 2:64, 3:65, 4:67, 5:68, 6:68, 7:66, 8:63, 9:58, 10:52, 1:46 },
  20: { 2:73, 3:74, 4:75, 5:76, 6:76, 7:74, 8:73, 9:70, 10:65, 1:58 },
  21: { 2:92, 3:93, 4:93, 5:94, 6:94, 7:92, 8:91, 9:90, 10:88, 1:85 },
};

/**
 * PERCEIVED WIN % â€” how confident players typically feel.
 * Based on research showing players overestimate when they have 17-19,
 * and underestimate when holding 12-16 ("stiff hands").
 * This is intentionally biased to show the gap vs actual.
 */
function getPerceivedWinPct(playerTotal, dealerUpcard) {
  // Players anchor heavily on their own total and underweight dealer threat
  // Research suggests a consistent overconfidence bias of +8-15% on good hands
  const dealerThreat = [9,10,1].includes(dealerUpcard) ? -5 : [2,3,4].includes(dealerUpcard) ? 3 : 0;

  if (playerTotal >= 20)      return Math.min(95, 88 + dealerThreat);
  if (playerTotal === 19)     return Math.min(90, 80 + dealerThreat);
  if (playerTotal === 18)     return Math.min(85, 72 + dealerThreat);  // overconfident here
  if (playerTotal === 17)     return Math.min(80, 63 + dealerThreat);  // significantly overconfident
  if (playerTotal >= 13)      return Math.min(70, 48 + dealerThreat);  // "feels bad but maybe"
  if (playerTotal === 12)     return 38 + dealerThreat;
  if (playerTotal >= 9)       return 58 + dealerThreat;                // feels great to have 9/10/11
  return 45 + dealerThreat;
}

/**
 * BUST RISK â€” probability of busting on the next card.
 * Simple: any 10-value card (4/13 of deck) busts if total > 11.
 */
function getBustRisk(playerTotal) {
  if (playerTotal <= 11) return 0;
  // Cards that would bust: all cards with value > (21 - playerTotal)
  const safeMax = 21 - playerTotal;
  if (safeMax <= 0) return 100;
  // In a standard deck: A=1or11, 2-9 face value, 10/J/Q/K = 10
  // Cards 1-safeMax are safe. Count safe denominations out of 13.
  let safeCount = 0;
  for (let v = 1; v <= Math.min(safeMax, 9); v++) safeCount++;
  if (safeMax >= 10) safeCount += 4; // 10,J,Q,K all count as 10
  return Math.round(((13 - safeCount) / 13) * 100);
}

function getDealerUpcardValue(card) {
  if (!card) return 7; // default if no card
  if (['J','Q','K'].includes(card.value)) return 10;
  if (card.value === 'A') return 1;
  return parseInt(card.value);
}

function updateOddsPanel() {
  const panel = document.getElementById('odds-panel');

  if (phase !== 'player' || playerCards.length === 0) {
    panel.classList.remove('visible');
    return;
  }

  panel.classList.add('visible');

  const pTotal = handTotal(playerCards);
  const dealerUpcard = dealerCards[0] ? getDealerUpcardValue(dealerCards[0]) : 7;

  // Clamp pTotal for table lookup
  const lookupTotal = Math.min(Math.max(pTotal, 4), 21);
  const actualRow = BASIC_STRATEGY_WIN_PCT[lookupTotal];
  const actualPct = actualRow ? (actualRow[dealerUpcard] || actualRow[10] || 40) : 40;
  const perceivedPct = getPerceivedWinPct(pTotal, dealerUpcard);
  const bustPct = getBustRisk(pTotal);

  // Update bars
  document.getElementById('bar-perceived').style.width = perceivedPct + '%';
  document.getElementById('bar-actual').style.width    = actualPct + '%';
  document.getElementById('bar-bust').style.width      = bustPct + '%';

  document.getElementById('pct-perceived').textContent = perceivedPct + '%';
  document.getElementById('pct-actual').textContent    = actualPct + '%';
  document.getElementById('pct-bust').textContent      = bustPct + '%';

  // Gap callout
  const gap = perceivedPct - actualPct;
  const gapEl = document.getElementById('odds-gap');

  if (Math.abs(gap) >= 8) {
    gapEl.classList.add('show');
    if (gap > 0) {
      gapEl.className = 'odds-gap show overconfident';
      if (gap >= 20) {
        gapEl.textContent = `You feel ${gap}% more confident than the math supports. This gap is where casinos profit.`;
      } else {
        gapEl.textContent = `You feel ${gap}% better about this hand than statistics suggest.`;
      }
    } else {
      gapEl.className = 'odds-gap show underconfident';
      gapEl.textContent = `You may be underestimating this hand by ${Math.abs(gap)}%. Basic strategy favours playing it.`;
    }
  } else {
    gapEl.classList.remove('show');
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEXT-HAND FORECAST ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Statistical blackjack baselines (6-deck, H17, basic strategy)
const BJ_BASE_LOSS_PCT   = 49.1;  // ~49% of hands result in a loss
const BJ_BASE_WIN_PCT    = 42.4;  // ~42% wins (remainder are pushes)
const BJ_LONG_RUN_LOSS   = 55.0;  // including pushes re-bet, practical loss rate
const HOUSE_EDGE_PCT     = 0.5;   // long-run expected loss per dollar wagered

function getDissuasionMessage(ag) {
  // Loss chasing â€” most dangerous state
  if (ag.netPL < 0 && ag.consecutiveLosses >= 2) {
    return 'You\'ve lost <strong>\' + ag.consecutiveLosses + \' hands in a row</strong>. The urge to win it back is called "loss chasing" â€” it\'s one of the strongest gambling urges, and it\'s exactly what keeps people playing past the point of reason.';
  }
  // Significantly down
  if (ag.netPL < -50) {
    return 'You\'re down <strong>$' + Math.abs(ag.netPL) + '</strong> this session. Statistically, continuing to play does not increase your chances of recovering that â€” it increases the expected total loss.';
  }
  // In the red, multiple hands played
  if (ag.netPL < 0 && ag.hands > 5) {
    return 'After <strong>\' + ag.hands + \' hands</strong> you\'re in the red. The house edge is small but relentless â€” it compounds with every hand dealt. There is no amount of play that erases it.';
  }
  // Winning streak â€” overconfidence risk
  if (ag.netPL > 0 && ag.consecutiveWins >= 2) {
    return 'You\'re on a run. This is when most people lose the most money â€” <strong>winning streaks feel like skill, not luck</strong>. The next hand has no memory of the last. The odds reset completely.';
  }
  // Up on the session
  if (ag.netPL > 30) {
    return 'You\'re ahead by <strong>$\' + ag.netPL + \'</strong>. That money is real. The longer you continue, the more likely the house edge pulls it back â€” that\'s not pessimism, it\'s arithmetic.';
  }
  // Long session
  if (ag.hands >= 15) {
    return '<strong>' + ag.hands + ' hands in.</strong> A casino processes hundreds of decisions an hour â€” the longer you play, the more the house edge compounds. Time at the table is the house\'s biggest advantage.';
  }
  if (ag.hands >= 8) {
    return 'Every hand is an independent event. There is no "due" win, no hot table, no momentum. <strong>The cards have no memory</strong> â€” only the math persists.';
  }
  // Default
  return 'Blackjack has some of the best odds in any casino â€” and the house still wins more than it loses over time. <strong>The next hand is more likely to lose than win.</strong> That\'s not a warning, it\'s a mathematical fact.';
}

function buildNextHandForecast() {
  // â”€â”€ Loss probability for next hand â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Base: 49.1%. Adjust slightly for session streak (regression to mean model).
  // NOTE: We show truth â€” each hand is independent. But we contextualise with
  // the long-run reality rather than implying hot/cold streaks.
  const played = AG.wins + AG.losses;
  let sessionLossPct = played > 0
    ? Math.round((AG.losses / played) * 100)
    : Math.round(BJ_BASE_LOSS_PCT);

  // Weighted blend: session result drifts toward true baseline over time
  // This prevents wild numbers on first few hands while showing truth at scale
  const weight = Math.min(played / 20, 1);  // full trust in session data after 20 hands
  const blendedLoss = Math.round(
    sessionLossPct * weight + BJ_BASE_LOSS_PCT * (1 - weight)
  );

  // Clamp to realistic range
  const displayLoss = Math.max(40, Math.min(70, blendedLoss));

  // â”€â”€ Circle arc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const circumference = 207.3; // 2Ï€ Ã— 33
  const offset = circumference * (1 - displayLoss / 100);
  const circleEl = document.getElementById('nhf-circle-fill');
  const numEl    = document.getElementById('nhf-prob-number');

  // Colour tier
  const tier = displayLoss >= 55 ? 'high' : displayLoss >= 49 ? 'mid' : 'low';
  circleEl.className = `nhf-circle-fill${tier === 'high' ? '' : ' ' + tier}`;
  numEl.className    = `nhf-prob-number${tier === 'high' ? '' : ' ' + tier}`;

  // Animate after a short delay (overlay just appeared)
  setTimeout(() => {
    circleEl.style.strokeDashoffset = offset;
    numEl.textContent = displayLoss + '%';
  }, 120);

  // â”€â”€ Context bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sessionLossForBar = played > 0 ? Math.round((AG.losses / played) * 100) : Math.round(BJ_BASE_LOSS_PCT);
  document.getElementById('nhf-bar-session').style.width = Math.min(sessionLossForBar, 100) + '%';
  document.getElementById('nhf-val-session').textContent = sessionLossForBar + '%';

  // â”€â”€ Headline + sub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const headlineEl = document.getElementById('nhf-headline');
  const subEl      = document.getElementById('nhf-sub');

  if (displayLoss >= 55) {
    headlineEl.textContent = `${displayLoss}% chance you lose the next hand`;
    subEl.textContent = 'Above the statistical average. Your session pattern leans unfavourable.';
  } else if (displayLoss >= 50) {
    headlineEl.textContent = `${displayLoss}% chance you lose the next hand`;
    subEl.textContent = 'Near the statistical baseline. Slightly more likely to lose than win.';
  } else {
    headlineEl.textContent = `${displayLoss}% chance you lose the next hand`;
    subEl.textContent = 'Below average â€” but losing is still the most probable single outcome.';
  }

  // â”€â”€ Dissuasion message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('nhf-message').innerHTML = getDissuasionMessage(AG);

  // â”€â”€ Expected loss projection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // House edge = 0.5% of total money wagered (not per hand profit/loss)
  // Per hand: bet Ã— 0.005 = expected loss
  // Over N hands: N Ã— bet Ã— 0.005
  const refBet = currentBet > 0 ? currentBet : (AG.lastBet || 10);
  const perHandLoss   = (refBet * 0.005).toFixed(2);           // e.g. $10 bet â†’ $0.05
  const over20Loss    = (refBet * 20 * 0.005).toFixed(2);      // e.g. 20 hands â†’ $1.00
  const over100Loss   = (refBet * 100 * 0.005).toFixed(2);     // e.g. 100 hands â†’ $5.00
  const totalWagered  = AG.totalWagered > 0 ? AG.totalWagered : refBet * AG.hands;
  const expectedTotalLoss = (totalWagered * 0.005).toFixed(2);

  let projText = 'At <strong>$' + refBet + '/hand</strong>: house expects to keep ';
  projText += '<strong>$' + perHandLoss + '</strong> per hand Â· ';
  projText += '<strong>$' + over20Loss + '</strong> over 20 hands Â· ';
  projText += '<strong>$' + over100Loss + '</strong> over 100 hands';
  if (AG.totalWagered > 0) {
    projText += ' Â· Based on $' + AG.totalWagered + ' wagered this session, expected house take: <strong>$' + expectedTotalLoss + '</strong>';
  }
  document.getElementById('nhf-projection').innerHTML = projText;
}
// â”€â”€ SESSION REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildReport() {
  const elapsed = Math.floor((Date.now() - AG.sessionStart) / 1000);
  const mm = Math.floor(elapsed / 60), ss = elapsed % 60;
  document.getElementById('r-time').textContent = mm > 0 ? `${mm}m ${ss}s` : `${ss}s`;
  document.getElementById('r-hands').textContent = AG.hands;
  document.getElementById('r-wins').textContent = AG.wins;

  const played = AG.wins + AG.losses;
  document.getElementById('r-winrate').textContent =
    played > 0 ? `${Math.round(AG.wins / played * 100)}%` : 'â€”';

  // Debt / profit box
  const box = document.getElementById('r-debt-box');
  const lbl = document.getElementById('r-debt-lbl');
  const amt = document.getElementById('r-debt-amount');

  if (AG.netPL < 0) {
    box.className = 'debt-box';
    lbl.textContent = 'NET LOSS THIS SESSION';
    amt.textContent = `-$${Math.abs(AG.netPL)}`;
  } else if (AG.netPL > 0) {
    box.className = 'debt-box profit';
    lbl.textContent = 'NET PROFIT THIS SESSION';
    amt.textContent = `+$${AG.netPL}`;
  } else {
    box.className = 'debt-box profit';
    lbl.textContent = 'BROKE EVEN';
    amt.textContent = '$0';
  }

  // Could have bought â€” richer version in report
  const loss = AG.totalLost;
  const buySection = document.getElementById('r-couldbuy');
  const buyList = document.getElementById('r-buy-list');
  buyList.innerHTML = '';

  if (loss >= 3) {
    buySection.style.display = 'block';
    buildCouldHaveBought(loss, buyList, 'big');
  } else {
    buySection.style.display = 'none';
  }
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
agInit();
setPhase('bet');
updateBetButtons();
</script>

<!-- ODDS TOOLTIP -->
<div id="odds-tooltip">
  <div class="tooltip-box">
    <div class="tooltip-title">HOW THE ODDS TRACKER WORKS</div>
    <div class="tooltip-body">
      <div class="tooltip-row"><div class="tooltip-swatch swatch-perceived"></div><strong style="color:var(--gold)">You Feel (amber)</strong></div>
      <p>A model of how confident most players feel at this score. People over-estimate their chances when they have a "good" total like 18 or 19, and underestimate when they hold 12â€“16.</p>
      <br>
      <div class="tooltip-row"><div class="tooltip-swatch swatch-actual"></div><strong style="color:#1abc9c">Actual Win % (green)</strong></div>
      <p>Calculated from basic strategy tables: given your total and the dealer's visible card, what percentage of hands statistically result in a win from this position.</p>
      <br>
      <div class="tooltip-row"><div class="tooltip-swatch swatch-bust"></div><strong style="color:var(--debt-col)">Bust Risk (red)</strong></div>
      <p>The probability that taking one more card (Hit) would put you over 21, based on your current total and how many high cards remain playable.</p>
      <br>
      <p style="opacity:0.6; font-size:0.82rem;">The gap between amber and green reveals a key gambling bias: most players consistently feel luckier than the math supports.</p>
    </div>
    <button class="tooltip-close" onclick="document.getElementById('odds-tooltip').classList.remove('show')">GOT IT</button>
  </div>
</div>
</body>
</html>